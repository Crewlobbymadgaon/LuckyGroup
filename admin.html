<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varavu - Chilavu (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest-admin.json">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4CAF50; }
    .closed { color: red; font-weight: bold; }
    label { display: block; margin-top: 10px; }
    select, input, button { margin-top: 5px; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <h1 id="tripHeading">Admin Panel</h1>
  <label for="tripSelect">Select Trip:</label>
  <select id="tripSelect">
    <option value="">-- Select Trip --</option>
    <option value="new">+ Create New Trip</option>
  </select>
  <button id="closeTripBtn" disabled>Close Current Trip</button>

  <h2>Expenses</h2>
  <form id="expenseForm">
    <label>Description: <input id="expenseDesc" required></label>
    <label>Amount: <input type="number" id="expenseAmount" required></label>
    <button type="submit">Add Expense</button>
  </form>
  <ul id="expenseList"></ul>

  <h2>Contributions</h2>
  <form id="contributionForm">
    <label>Contributor: <input id="contributor" required></label>
    <label>Amount: <input type="number" id="contributionAmount" required></label>
    <button type="submit">Add Contribution</button>
  </form>
  <ul id="contributionList"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc, updateDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ðŸ”¹ Your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APPID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentTripId = null;
    let currentTripClosed = false;
    let unsubExpenses = null;
    let unsubContribs = null;

    // ðŸ”¹ Save active trip in meta/currentTrip
    async function updateMeta() {
      await setDoc(doc(db, "meta", "currentTrip"), { tripId: currentTripId });
    }

    function updateHeading(trip) {
      const heading = document.getElementById("tripHeading");
      heading.textContent = "Admin Panel - " + trip.name;
      if (trip.closed) {
        heading.classList.add("closed");
        document.getElementById("closeTripBtn").disabled = true;
      } else {
        heading.classList.remove("closed");
        document.getElementById("closeTripBtn").disabled = false;
      }
    }

    async function loadTrips() {
      const snap = await getDoc(doc(db, "meta", "currentTrip"));
      if (snap.exists()) {
        currentTripId = snap.data().tripId;
      }

      const q = query(collection(db, "trips"), orderBy("date", "desc"));
      onSnapshot(q, (snapshot) => {
        const select = document.getElementById("tripSelect");
        select.innerHTML = `
          <option value="">-- Select Trip --</option>
          <option value="new">+ Create New Trip</option>
        `;
        snapshot.forEach(docSnap => {
          const opt = document.createElement("option");
          opt.value = docSnap.id;
          opt.textContent = docSnap.data().name;
          if (docSnap.id === currentTripId) opt.selected = true;
          select.appendChild(opt);
        });

        if (currentTripId) {
          const tripDoc = snapshot.docs.find(d => d.id === currentTripId);
          if (tripDoc) {
            currentTripClosed = !!tripDoc.data().closed;
            updateHeading(tripDoc.data());
            startListeners();
          }
        }
      });
    }

    // ðŸ”¹ Trip selection logic
    document.getElementById("tripSelect").addEventListener("change", async (e) => {
      const val = e.target.value;
      if (val === "new") {
        const name = prompt("Enter Trip Name:");
        if (!name) {
          e.target.value = "";
          return;
        }
        const tripId = Date.now().toString();
        await setDoc(doc(db, "trips", tripId), {
          name: name,
          date: new Date().toISOString(),
          closed: false
        });
        currentTripId = tripId;
        currentTripClosed = false;
        await updateMeta();
        loadTrips();
      } else if (val) {
        currentTripId = val;
        await updateMeta();
        const tripDoc = await getDoc(doc(db, "trips", currentTripId));
        if (tripDoc.exists()) {
          currentTripClosed = !!tripDoc.data().closed;
          updateHeading(tripDoc.data());
          startListeners();
        }
      }
    });

    function startListeners() {
      if (!currentTripId) return;

      if (unsubExpenses) unsubExpenses();
      if (unsubContribs) unsubContribs();

      const expQ = query(collection(db, "trips", currentTripId, "expenses"), orderBy("time", "desc"));
      unsubExpenses = onSnapshot(expQ, (snapshot) => {
        const list = document.getElementById("expenseList");
        list.innerHTML = "";
        snapshot.forEach(docSnap => {
          const li = document.createElement("li");
          const d = docSnap.data();
          li.textContent = `${d.desc} - â‚¹${d.amount}`;
          list.appendChild(li);
        });
      });

      const conQ = query(collection(db, "trips", currentTripId, "contributions"), orderBy("time", "desc"));
      unsubContribs = onSnapshot(conQ, (snapshot) => {
        const list = document.getElementById("contributionList");
        list.innerHTML = "";
        snapshot.forEach(docSnap => {
          const li = document.createElement("li");
          const d = docSnap.data();
          li.textContent = `${d.contributor} - â‚¹${d.amount}`;
          list.appendChild(li);
        });
      });
    }

    // ðŸ”¹ Forms
    document.getElementById("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentTripId || currentTripClosed) return alert("Trip closed or not selected!");
      const desc = document.getElementById("expenseDesc").value;
      const amt = parseFloat(document.getElementById("expenseAmount").value);
      await addDoc(collection(db, "trips", currentTripId, "expenses"), {
        desc, amount: amt, time: Date.now()
      });
      e.target.reset();
    });

    document.getElementById("contributionForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentTripId || currentTripClosed) return alert("Trip closed or not selected!");
      const contr = document.getElementById("contributor").value;
      const amt = parseFloat(document.getElementById("contributionAmount").value);
      await addDoc(collection(db, "trips", currentTripId, "contributions"), {
        contributor: contr, amount: amt, time: Date.now()
      });
      e.target.reset();
    });

    // ðŸ”¹ Close trip
    document.getElementById("closeTripBtn").addEventListener("click", async () => {
      if (!currentTripId) return;
      await updateDoc(doc(db, "trips", currentTripId), { closed: true });
      currentTripClosed = true;
      document.getElementById("closeTripBtn").disabled = true;
      document.getElementById("tripHeading").classList.add("closed");
    });

    loadTrips();
  </script>
</body>
</html>
