<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varavu - Chilavu (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon (fallback PNG recommended) -->
<link rel="icon" type="image/png" href="favicon.png">

<!-- Apple (still requires PNG) -->
<link rel="apple-touch-icon" href="icon-admin-192.png">

<!-- Manifest (contains WebP + PNG fallback) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">
  

<!-- iOS Support -->
<link rel="apple-touch-icon" href="icon-admin-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
   body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#4CAF50; color:white; padding:1rem; text-align:center; }
    header h1 { margin:0; }
    main { padding:1rem; max-width:1000px; margin:auto; }
    select, button, input { padding:0.6rem; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; font-weight:bold; }
    .danger { background:red; color:white; }
    .secondary { background:#ccc; }
    .center { text-align:center; }

    .card { background:white; border-radius:10px; padding:1rem; margin-top:1rem;
            box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .card h2 { margin-top:0; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:0.5rem; background:white; }
    th, td { padding:0.6rem; border-bottom:1px solid #ddd; text-align:center; }
    th { background:#f1f1f1; }
    .deleteBtn { background:red; color:#fff; border:none; padding:0.3rem 0.6rem;
                 border-radius:4px; cursor:pointer; }
    .approveBtn { background:green; color:#fff; border:none; padding:0.3rem 0.6rem;
                  border-radius:4px; cursor:pointer; margin-right:4px; }
    .positive { color:green; }
    .negative { color:red; }
    .date-header { background:#e3f2fd; font-weight:bold; text-align:left; padding:0.5rem; }

    #tripList { display:none; margin-top:0.8rem; }
    .trip-item { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <div id="activeTrip" style="margin-top:0.3rem;">No Active Trip</div>
  </header>

  <main>
    <!-- Trip Selection -->
    <div class="card center">
      <h2>Trips</h2>
      <select id="tripSelect"></select>
      <button id="closeTripBtn" class="danger" style="margin-top:0.5rem;">Close Active Trip</button>
      <button id="deleteTripBtn" class="danger" style="margin-top:0.5rem; display:none;">Delete Trip</button>
      <button id="exportBtn" class="secondary" style="margin-top:0.5rem;">â¬‡ Export to HTML</button>
      <div id="tripList"></div>
    </div>

    <!-- Expenses -->
    <div class="card">
      <h2>All Expenses</h2>
      <div id="expensesContainer"></div>
    </div>

    <!-- Totals -->
    <div class="card">
      <h2>Summary</h2>
      <div id="totals" style="text-align:center;font-weight:bold;">Total: â‚¹0 | Per Head: â‚¹0</div>
      <table>
        <thead><tr><th>Member</th><th>Paid</th><th>Balance</th><th>Action</th></tr></thead>
        <tbody id="memberTotals"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
      onSnapshot, getDocs, getDoc, setDoc, query, orderBy, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJ4oMxrYzcBfK_34EBqHCrH0lweVFdzjI",
      authDomain: "varavu-chilavu.firebaseapp.com",
      projectId: "varavu-chilavu",
      storageBucket: "varavu-chilavu.appspot.com",
      messagingSenderId: "69022331814",
      appId: "1:69022331814:web:4c33a907c5a47970611567"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentTripId = null;
    let expensesCol = null;
    let currentTripClosed = false;
    let currentTripName = "";
    let cachedExpenses = [];

    function ddmmyyyy(ts) { return new Date(ts).toLocaleDateString("en-GB"); }
    function toInt(v) { return parseInt(v) || 0; }

    async function loadTrips() {
      const tripsSnap = await getDocs(collection(db,"trips"));
      const select = document.getElementById("tripSelect");
      select.innerHTML = '<option value="">--Select Trip--</option><option value="new">+ Create New Trip</option>';

      let listDiv = document.getElementById("tripList");
      listDiv.innerHTML = "";

      tripsSnap.forEach(docSnap => {
        const t = docSnap.data();
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = `${t.name} (${t.date ? ddmmyyyy(new Date(t.date)):""}) ${t.closed?"[Closed]":""}`;
        select.appendChild(opt);

        const div = document.createElement("div");
        div.className="trip-item";
        div.innerHTML = `<span>${t.name} (${t.date? ddmmyyyy(new Date(t.date)):""}) ${t.closed?"[Closed]":""}</span>
                         <button class="deleteBtn">ðŸ—‘</button>`;
        div.querySelector("button").onclick = async ()=>{
          if(confirm("Delete trip?")) await deleteDoc(doc(db,"trips",docSnap.id));
          loadTrips();
        };
        listDiv.appendChild(div);
      });

      const metaDoc = await getDoc(doc(db,"meta","currentTrip"));
      if(metaDoc.exists()) {
        currentTripId = metaDoc.data().tripId;
        if(currentTripId) {
          const tripDoc = await getDoc(doc(db,"trips",currentTripId));
          if(tripDoc.exists()){
            currentTripClosed=tripDoc.data().closed;
            currentTripName=tripDoc.data().name;
            if(!currentTripClosed){
              select.value=currentTripId;
              updateHeading(tripDoc.data());
              startExpenseListener();
            } else {
              updateHeading(tripDoc.data());
            }
          }
        }
      }
    }

    function updateHeading(tripData){
      const closeBtn=document.getElementById("closeTripBtn");
      const deleteBtn=document.getElementById("deleteTripBtn");

      if(!currentTripId) {
        document.getElementById("activeTrip").innerText="No Active Trip";
        closeBtn.style.display="inline-block";
        deleteBtn.style.display="none";
        return;
      }
      currentTripName=tripData.name;
      if(tripData.closed){
        document.getElementById("activeTrip").innerText=`Viewing Closed Trip: ${tripData.name} (${ddmmyyyy(new Date(tripData.date))})`;
        closeBtn.style.display="none";
        deleteBtn.style.display="inline-block";
      } else {
        document.getElementById("activeTrip").innerText=`Active Trip: ${tripData.name} (${ddmmyyyy(new Date(tripData.date))})`;
        closeBtn.style.display="inline-block";
        deleteBtn.style.display="none";
      }
    }

    async function updateMeta(){
      await setDoc(doc(db,"meta","currentTrip"),{tripId:currentTripId});
    }

    function startExpenseListener(){
      if(!currentTripId) return;
      expensesCol = collection(db,"trips",currentTripId,"expenses");
      const q=query(expensesCol,orderBy("createdAt","asc"));
      onSnapshot(q,snap=>{
        cachedExpenses=[];
        snap.forEach(d=>cachedExpenses.push({id:d.id,...d.data()}));
        renderExpenses(cachedExpenses);
      });
    }

    async function renderExpenses(expenses) {
      const container = document.getElementById("expensesContainer");
      container.innerHTML = "";
      let total = 0;
      let membersPaid = {};

      let grouped = {};
      expenses.forEach(e => {
        const d = ddmmyyyy(e.date);
        if (!grouped[d]) grouped[d] = [];
        grouped[d].push(e);
        total += toInt(e.amount);
        membersPaid[e.user] = (membersPaid[e.user] || 0) + toInt(e.amount);
      });

      // Render expenses
      for (const date of Object.keys(grouped)) {
        const h = document.createElement("div");
        h.className = "date-header";
        h.innerText = date;
        container.appendChild(h);

        const table = document.createElement("table");
        table.innerHTML = `<thead><tr><th>Member</th><th>Amount</th><th>Description</th><th>Action</th></tr></thead>`;
        const tbody = document.createElement("tbody");

        grouped[date].forEach(e => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${e.user}</td>
                          <td>â‚¹${e.amount}</td>
                          <td>${e.description}</td>
                          <td>${currentTripClosed ? "" : "<button class='deleteBtn'>Delete</button>"}</td>`;
          if (!currentTripClosed)
            tr.querySelector("button").onclick = async () => {
              await deleteDoc(doc(db, "trips", currentTripId, "expenses", e.id));
            };
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      }

      // Get all joined members
      const membersSnap = await getDocs(collection(db, "trips", currentTripId, "members"));
      let allMembers = [];
      membersSnap.forEach(d => allMembers.push(d.id));

      // Merge with paid
      allMembers.forEach(m => { if (!membersPaid[m]) membersPaid[m] = 0; });

      const perHead = allMembers.length ? Math.round(total / allMembers.length) : 0;
      document.getElementById("totals").innerText = `Total: â‚¹${total} | Per Head: â‚¹${perHead}`;

      const sumBody = document.getElementById("memberTotals");
      sumBody.innerHTML = "";
      for (const m of allMembers) {
        const memberDoc = membersSnap.docs.find(d => d.id === m);
        const approved = memberDoc?.data()?.approved ?? false;

        const paid = membersPaid[m] || 0;
        const bal = paid - perHead;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${m}</td>
                        <td>â‚¹${paid}</td>
                        <td class="${bal >= 0 ? 'positive' : 'negative'}">
                          ${bal >= 0 ? '+â‚¹' + bal : '-â‚¹' + Math.abs(bal)}
                        </td>
                        <td>
                          ${approved ? '<span style="color:green;">âœ” Approved</span>' : `<button class="approveBtn">Approve</button>`}
                          ${currentTripClosed ? "" : `<button class="deleteBtn">ðŸ—‘</button>`}
                        </td>`;
        
        // approve button
        if (!approved) {
          tr.querySelector(".approveBtn").onclick = async () => {
            await updateDoc(doc(db, "trips", currentTripId, "members", m), { approved: true });
            renderExpenses(cachedExpenses);
          };
        }

        // delete button
        if (!currentTripClosed) {
          tr.querySelector(".deleteBtn").onclick = async () => {
            if (confirm("Remove this member and all their expenses?")) {
              const batch = writeBatch(db);
              batch.delete(doc(db, "trips", currentTripId, "members", m));
              const expSnap = await getDocs(collection(db, "trips", currentTripId, "expenses"));
              expSnap.forEach(e => { if (e.data().user === m) batch.delete(e.ref); });
              await batch.commit();

              // Clear local login if this was the logged-in user
              if (localStorage.getItem("memberName") === m) {
                localStorage.removeItem("memberName");
              }
              renderExpenses(cachedExpenses);
            }
          };
        }

        sumBody.appendChild(tr);
      }
    }

    loadTrips();
  </script>
</body>
</html>
