<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varavu - Chilavu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon (fallback PNG recommended) -->
<link rel="icon" type="image/png" href="favicon.png">

<!-- Apple (still requires PNG) -->
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Manifest (contains WebP + PNG fallback) -->

<meta name="theme-color" content="#4CAF50">
  
<link rel="manifest" href="manifest.json">
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw-user.js", { scope: "./" });
}
</script>
<!-- iOS Support -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#4CAF50; color:white; padding:1rem; text-align:center; }
    header h1 { margin:0; }
    #tripInfo { font-size:1rem; margin-top:0.3rem; }
    main { padding:1rem; max-width:800px; margin:auto; }
    input, button { width:100%; padding:0.6rem; margin:0.3rem 0; border-radius:6px; border:1px solid #ccc; }
    button { background:#4CAF50; color:#fff; border:none; font-weight:bold; cursor:pointer; }
    button:hover { background:#45a049; }
    table { width:100%; border-collapse:collapse; background:white; margin-top:0.5rem; }
    th, td { padding:0.6rem; border-bottom:1px solid #ddd; text-align:center; }
    th { background:#f1f1f1; }
    .date-heading { margin-top:1rem; font-weight:bold; }
    .deleteBtn { background:red; color:#fff; border:none; padding:0.3rem 0.6rem; border-radius:4px; cursor:pointer; }
    .positive { color:green; }
    .negative { color:red; }
    .actionBtn { padding:0.3rem 0.6rem; border-radius:4px; }
  </style>
</head>
<body>
  <header>
    <h1>Tour Expense</h1>
    <div id="tripInfo">
      <div id="tripName">Loading trip...</div>
      <div id="tripDate"></div>
    </div>
    <div id="currentUserDisplay"></div>
  </header>

  <main>
    <div id="loginDiv">
      <input id="username" type="text" placeholder="Enter your name">
      <button id="loginBtn">Join</button>
    </div>

    <div id="waitingDiv" style="display:none; text-align:center; font-weight:bold; color:#555;">
      Waiting for admin approval...
    </div>

    <div id="rejectedDiv" style="display:none; text-align:center; font-weight:bold; color:red;">
      Rejected by admin. Please try with another name.
    </div>

    <div id="appDiv" style="display:none;">
      <h2>Add Expense</h2>
      <input id="amount" type="number" placeholder="Amount">
      <input id="description" type="text" placeholder="Description">
      <input id="date" type="date">
      <button id="addBtn">Add</button>

      <h2>Expenses</h2>
      <div id="expensesContainer"></div>

      <h2>Summary</h2>
      <div id="summaryLine"></div>
      <table>
        <thead><tr><th>Member</th><th>Paid</th><th>Balance</th></tr></thead>
        <tbody id="memberTotals"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJ4oMxrYzcBfK_34EBqHCrH0lweVFdzjI",
      authDomain: "varavu-chilavu.firebaseapp.com",
      projectId: "varavu-chilavu",
      storageBucket: "varavu-chilavu.appspot.com",
      messagingSenderId: "69022331814",
      appId: "1:69022331814:web:4c33a907c5a47970611567"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let currentTripId = null;
    let expensesCol = null;
    let expensesState = [];
    let membersState = new Set();

    function toInt(v) { return parseInt(v) || 0; }
    function ddmmyyyy(ts) { return new Date(ts).toLocaleDateString("en-GB"); }

    async function loadTrip() {
      const metaDoc = await getDoc(doc(db, "meta", "currentTrip"));
      if (metaDoc.exists()) {
        currentTripId = metaDoc.data().tripId;
        if (!currentTripId) {
          document.getElementById("tripName").textContent = "No Active Trip";
          return;
        }
        expensesCol = collection(db, "trips", currentTripId, "expenses");
        const tripDoc = await getDoc(doc(db, "trips", currentTripId));
        if (tripDoc.exists()) {
          const t = tripDoc.data();
          document.getElementById("tripName").textContent = t.name || "Unnamed Trip";
          document.getElementById("tripDate").textContent = t.date ? ddmmyyyy(new Date(t.date)) : "";
        }
        loadMembers(); // now live listener
      } else {
        document.getElementById("tripName").textContent = "No Active Trip";
      }
    }

    // ðŸ”¥ FIXED: members now update live
    function loadMembers() {
      const membersCol = collection(db, "trips", currentTripId, "members");
      onSnapshot(membersCol, (snap) => {
        membersState.clear();
        snap.forEach(d => {
          const data = d.data();
          if (data.status === "approved") {
            membersState.add(d.id);
          }
        });
        render(); // re-render summary when members change
      });
    }

    function render() {
      const container = document.getElementById("expensesContainer");
      container.innerHTML = "";
      let total = 0;
      const memberTotals = {};

      // group by date
      const grouped = {};
      expensesState.forEach(e => {
        const d = ddmmyyyy(e.date);
        if (!grouped[d]) grouped[d] = [];
        grouped[d].push(e);
      });

      Object.keys(grouped).forEach(dateStr => {
        const h = document.createElement("div");
        h.className = "date-heading";
        h.textContent = "ðŸ“… " + dateStr;
        container.appendChild(h);

        const table = document.createElement("table");
        table.innerHTML = "<thead><tr><th>Name</th><th>Amount</th><th>Description</th><th></th></tr></thead><tbody></tbody>";
        const tbody = table.querySelector("tbody");

        grouped[dateStr].sort((a, b) => a.createdAt - b.createdAt); // sort by createdAt

        grouped[dateStr].forEach(e => {
          const tr = document.createElement("tr");

          if (e.user === currentUser) {
            const tdUser = document.createElement("td");
            tdUser.textContent = e.user;

            const tdAmt = document.createElement("td");
            tdAmt.textContent = "â‚¹" + e.amount;
            tdAmt.style.cursor = "pointer";
            tdAmt.onclick = () => {
              const input = document.createElement("input");
              input.type = "number";
              input.value = e.amount;
              input.style.width = "80px";
              tdAmt.innerHTML = "";
              tdAmt.appendChild(input);
              input.focus();
              input.onblur = async () => {
                await updateDoc(doc(db, "trips", currentTripId, "expenses", e.id), {
                  amount: toInt(input.value)
                });
              };
              input.onkeypress = ev => { if (ev.key === "Enter") input.blur(); };
            };

            const tdDesc = document.createElement("td");
            tdDesc.textContent = e.description;
            tdDesc.style.cursor = "pointer";
            tdDesc.onclick = () => {
              const input = document.createElement("input");
              input.type = "text";
              input.value = e.description;
              input.style.width = "150px";
              tdDesc.innerHTML = "";
              tdDesc.appendChild(input);
              input.focus();
              input.onblur = async () => {
                await updateDoc(doc(db, "trips", currentTripId, "expenses", e.id), {
                  description: input.value
                });
              };
              input.onkeypress = ev => { if (ev.key === "Enter") input.blur(); };
            };

            const tdAction = document.createElement("td");
            const delBtn = document.createElement("button");
            delBtn.className = "actionBtn deleteBtn";
            delBtn.textContent = "ðŸ—‘ï¸";
            delBtn.onclick = async () => {
              await deleteDoc(doc(db, "trips", currentTripId, "expenses", e.id));
            };
            tdAction.appendChild(delBtn);

            tr.appendChild(tdUser);
            tr.appendChild(tdAmt);
            tr.appendChild(tdDesc);
            tr.appendChild(tdAction);

          } else {
            tr.innerHTML = `
              <td>${e.user}</td>
              <td>â‚¹${e.amount}</td>
              <td>${e.description}</td>
              <td></td>`;
          }

          tbody.appendChild(tr);
          total += toInt(e.amount);
          memberTotals[e.user] = (memberTotals[e.user] || 0) + toInt(e.amount);
        });
        container.appendChild(table);
      });

      const allMembers = Array.from(membersState);
      const perHead = allMembers.length ? total / allMembers.length : 0;
      document.getElementById("summaryLine").textContent = 
        `Total: â‚¹${total} | Per Head: â‚¹${perHead.toFixed(2)}`;

      const tb = document.getElementById("memberTotals");
      tb.innerHTML = "";
      allMembers.forEach(name => {
        const paid = memberTotals[name] || 0;
        const bal = paid - perHead;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>â‚¹${paid}</td>
          <td class="${bal >= 0 ? 'positive':'negative'}">${bal >= 0 ? "+â‚¹"+bal.toFixed(2) : "-â‚¹"+Math.abs(bal).toFixed(2)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    async function login(name) {
      currentUser = name;
      const memberRef = doc(db, "trips", currentTripId, "members", name);

      // avoid resetting approved members back to pending
      const existing = await getDoc(memberRef);
      if (!existing.exists() || existing.data().status !== "approved") {
        await setDoc(memberRef, {
          joinedAt: Date.now(),
          status: "pending"
        }, { merge: true });
      }

      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("waitingDiv").style.display = "block";
      document.getElementById("rejectedDiv").style.display = "none";
      document.getElementById("appDiv").style.display = "none";
      document.getElementById("currentUserDisplay").innerText = "Waiting for admin approval...";

      onSnapshot(memberRef, snap => {
        if (!snap.exists()) {
          document.getElementById("waitingDiv").style.display = "none";
          document.getElementById("rejectedDiv").style.display = "block";
          document.getElementById("currentUserDisplay").innerText = "";
          localStorage.removeItem("user");
          return;
        }
        const data = snap.data();
        if (data.status === "approved") {
          localStorage.setItem("user", name);
          document.getElementById("waitingDiv").style.display = "none";
          document.getElementById("rejectedDiv").style.display = "none";
          document.getElementById("appDiv").style.display = "block";
          document.getElementById("currentUserDisplay").innerText = "Hello, " + name;

          const q = query(expensesCol, orderBy("createdAt", "asc"));
          onSnapshot(q, snap => {
            expensesState = [];
            snap.forEach(d => {
              expensesState.push({ id: d.id, ...d.data() });
            });
            render();
          });
        }
      });
    }

    window.onload = async () => {
      await loadTrip();
      const saved = localStorage.getItem("user");
      if (saved) login(saved);

      document.getElementById("loginBtn").onclick = () => {
        const name = document.getElementById("username").value.trim();
        if (!name) return alert("Enter name");
        login(name);
      };

      document.getElementById("addBtn").onclick = async () => {
        const amt = document.getElementById("amount").value;
        const desc = document.getElementById("description").value;
        const d = document.getElementById("date").value;
        if (!amt || !desc || !d) return alert("Fill all fields");
        await addDoc(expensesCol, {
          user: currentUser,
          amount: toInt(amt),
          description: desc,
          date: new Date(d).getTime(),
          createdAt: Date.now()
        });
        document.getElementById("amount").value="";
        document.getElementById("description").value="";
        document.getElementById("date").value="";
      };
    };
  </script>
</body>
  </html>
