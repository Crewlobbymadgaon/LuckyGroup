<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varavu - Chilavu (Members)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Favicon -->
<link rel="icon" type="image/png" href="favicon.png">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">

<!-- iOS Support -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header { background: #4CAF50; color: white; padding: 1rem; text-align: center; }
    main { padding: 1rem; }
    label { display: block; margin-top: 1rem; }
    input, button { width: 100%; padding: 0.6rem; margin-top: 0.3rem; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #4CAF50; color: white; border: none; font-weight: bold; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { padding: 0.6rem; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f1f1f1; }
    tr:hover { background: #fafafa; }
    .deleteBtn { background: red; color: white; padding: 0.3rem 0.6rem; border: none; border-radius: 4px; cursor: pointer; }
    .editable { cursor: pointer; border-bottom: 1px dashed transparent; }
    .editable:hover { border-bottom: 1px dashed #333; }
    .table-container { overflow-x: auto; }
    #totals { margin-top: 1rem; font-weight: bold; background: #fff; padding: 0.8rem; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .positive { color: green; }
    .negative { color: red; }
  </style>
</head>
<body>
  <header>
    <h1>Varavu - Chilavu (Members)</h1>
    <div id="currentUserDisplay"></div>
  </header>
  <main>
    <div id="loginDiv">
      <label>Enter Your Name</label>
      <input id="username" type="text" placeholder="Your name">
      <button id="loginBtn">Join</button>
    </div>

    <div id="appDiv" style="display:none;">
      <h2>Add Expense</h2>
      <label>Amount</label>
      <input id="amount" type="number">
      <label>Description</label>
      <input id="description" type="text">
      <button id="addBtn">Add</button>

      <h2>Expenses</h2>
      <div class="table-container">
        <table id="expensesTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Amount</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="expensesBody"></tbody>
        </table>
      </div>

      <div id="totals">
        <div id="summaryLine">Total: ₹0 | Per Head: ₹0</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Member</th>
                <th>Paid</th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody id="memberTotals"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBJ4oMxrYzcBfK_34EBqHCrH0lweVFdzjI",
      authDomain: "varavu-chilavu.firebaseapp.com",
      projectId: "varavu-chilavu",
      storageBucket: "varavu-chilavu.appspot.com",
      messagingSenderId: "69022331814",
      appId: "1:69022331814:web:4c33a907c5a47970611567"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const expensesCol = collection(db, "expenses");

    let currentUser = null;

    function makeEditable(td, docId, field, oldValue) {
      td.onclick = null;
      const input = document.createElement("input");
      input.type = field === "amount" ? "number" : "text";
      input.value = oldValue;
      input.style.width = "100%";
      input.onblur = async () => {
        const newVal = input.value.trim();
        if (newVal && newVal !== oldValue) {
          await updateDoc(doc(db, "expenses", docId), { [field]: field === "amount" ? parseInt(newVal) : newVal });
        }
        td.textContent = field === "amount" ? "₹" + newVal : newVal;
        td.className = "editable";
        td.onclick = () => makeEditable(td, docId, field, newVal);
      };
      td.textContent = "";
      td.appendChild(input);
      input.focus();
    }

    function renderExpenses(snapshot) {
      const tbody = document.getElementById("expensesBody");
      tbody.innerHTML = "";

      let total = 0;
      const members = new Set();
      const memberTotals = {};

      snapshot.forEach(docSnap => {
        const exp = docSnap.data();
        const tr = document.createElement("tr");

        // Name
        const tdUser = document.createElement("td");
        tdUser.textContent = exp.user;
        members.add(exp.user);
        if (!memberTotals[exp.user]) memberTotals[exp.user] = 0;
        memberTotals[exp.user] += parseInt(exp.amount);
        tr.appendChild(tdUser);

        // Amount
        const tdAmt = document.createElement("td");
        tdAmt.textContent = "₹" + exp.amount;
        if (exp.user === currentUser) {
          tdAmt.className = "editable";
          tdAmt.onclick = () => makeEditable(tdAmt, docSnap.id, "amount", exp.amount);
        }
        tr.appendChild(tdAmt);

        // Description
        const tdDesc = document.createElement("td");
        tdDesc.textContent = exp.description;
        if (exp.user === currentUser) {
          tdDesc.className = "editable";
          tdDesc.onclick = () => makeEditable(tdDesc, docSnap.id, "description", exp.description);
        }
        tr.appendChild(tdDesc);

        // Delete button
        const tdDel = document.createElement("td");
        if (exp.user === currentUser) {
          const delBtn = document.createElement("button");
          delBtn.className = "deleteBtn";
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => {
            await deleteDoc(doc(db, "expenses", docSnap.id));
          };
          tdDel.appendChild(delBtn);
        }
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
        total += parseInt(exp.amount);
      });

      const perHead = members.size > 0 ? Math.round(total / members.size) : 0;
      document.getElementById("summaryLine").textContent = `Total: ₹${total} | Per Head: ₹${perHead}`;

      // Settlement table
      const memberBody = document.getElementById("memberTotals");
      memberBody.innerHTML = "";
      for (const [member, amt] of Object.entries(memberTotals)) {
        const balance = amt - perHead;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${member}</td>
          <td>₹${amt}</td>
          <td class="${balance >= 0 ? 'positive' : 'negative'}">
            ${balance >= 0 ? '+₹' + balance : '-₹' + Math.abs(balance)}
          </td>
        `;
        memberBody.appendChild(row);
      }
    }

    function login(name) {
      currentUser = name;
      localStorage.setItem("user", name);
      document.getElementById("currentUserDisplay").innerText = "Hello, " + name;
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("appDiv").style.display = "block";

      const q = query(expensesCol, orderBy("createdAt", "asc"));
      onSnapshot(q, renderExpenses);
    }

    window.onload = () => {
      const saved = localStorage.getItem("user");
      if (saved) login(saved);

      document.getElementById("loginBtn").onclick = () => {
        const name = document.getElementById("username").value.trim();
        if (!name) return alert("Enter name");
        login(name);
      };

      document.getElementById("addBtn").onclick = async () => {
        const amt = document.getElementById("amount").value;
        const desc = document.getElementById("description").value;
        if (!amt || !desc) return alert("Fill both");
        await addDoc(expensesCol, { 
          user: currentUser, 
          amount: parseInt(amt), 
          description: desc, 
          createdAt: Date.now()
        });
        document.getElementById("amount").value = "";
        document.getElementById("description").value = "";
      };
    };
  </script>
</body>
        </html>
